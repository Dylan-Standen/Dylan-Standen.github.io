import React, { useEffect, useMemo, useState } from "react";
import { motion, AnimatePresence } from "framer-motion";
import ReactMarkdown from "react-markdown";
import {
  BookOpenText,
  FolderGit2,
  UserRound,
  Plus,
  Moon,
  Sun,
  PencilLine,
  Trash2,
  Search,
  Download,
  Upload,
  Link as LinkIcon,
  FileText,
} from "lucide-react";

// =============================================
// Personal Website — Single-file React App
// Pages: Blog, Projects, About
// Data persists in localStorage; export/import supported
// =============================================

// ---- Utilities ----
const ls = {
  get(key, fallback) {
    try {
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : fallback;
    } catch (_) {
      return fallback;
    }
  },
  set(key, value) {
    try {
      localStorage.setItem(key, JSON.stringify(value));
    } catch (_) {}
  },
};

const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
const fmtDate = (d) => new Date(d).toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
const slugify = (s) =>
  s
    .toLowerCase()
    .replace(/[^a-z0-9\s-]/g, "")
    .trim()
    .replace(/\s+/g, "-")
    .slice(0, 80);

// ---- Initial demo content ----
const DEMO_PROFILE = {
  name: "Your Name",
  tagline: "Essays on mathematics & physics",
  location: "",
  email: "",
  bio: `Welcome! I'm a curious human who writes about math and physics—sometimes proofs, sometimes intuition, always with heart.\n\nThis site is 100% yours: edit anything, add posts and projects, and export your data as JSON.`,
  links: [
    { label: "GitHub", url: "https://github.com/" },
    { label: "Twitter", url: "https://x.com/" },
  ],
  avatarUrl: "",
};

const DEMO_POSTS = [
  {
    id: uid(),
    title: "Why Euler's Formula Feels Inevitable",
    topic: "mathematics",
    content:
      `When you stare at $e^{i\theta}$ long enough, circles sneak into exponentials.\n\nKey intuition: rotating is *adding angles*. The complex plane turns multiplication into rotation, so exponentials that add in the exponent map to rotations that add in angle.\n\n> TL;DR: derivatives of sin/cos keep cycling, so the exponential series wraps them together.\n\n**Sketch**\n\nWe can motivate Euler's formula from the power series:\n\n- $e^x = 1 + x + x^2/2! + x^3/3! + \cdots$\n- $\cos x = 1 - x^2/2! + x^4/4! - \cdots$\n- $\sin x = x - x^3/3! + x^5/5! - \cdots$\n\nPlugging $ix$ into $e^x$ and grouping real/imag parts gives $\cos x + i\sin x$.`,
    createdAt: Date.now() - 1000 * 60 * 60 * 24 * 14,
    updatedAt: Date.now() - 1000 * 60 * 60 * 24 * 14,
  },
  {
    id: uid(),
    title: "Noether's Theorem in Plain English",
    topic: "physics",
    content:
      `Every symmetry writes a check that a conservation law cashes.\n\n- Time shift symmetry → energy conserved.\n- Space translation → momentum conserved.\n- Rotation → angular momentum conserved.\n\nThink of the Lagrangian as a promise: if it doesn't change under some transformation, there's a hidden constant riding along in the equations of motion.`,
    createdAt: Date.now() - 1000 * 60 * 60 * 24 * 9,
    updatedAt: Date.now() - 1000 * 60 * 60 * 24 * 9,
  },
];

const DEMO_PROJECTS = [
  {
    id: uid(),
    title: "LaTeX Essay Template",
    description: "A tidy LaTeX setup for physics notes with minted, cleveref, and a clean title page.",
    projectUrl: "https://example.com",
    pdfUrl: "https://arxiv.org/pdf/2101.00001.pdf",
    tags: ["latex", "template"],
  },
  {
    id: uid(),
    title: "Numerical ODE Solver",
    description: "Tiny TypeScript toy using RK4 to visualize phase portraits.",
    projectUrl: "https://example.com",
    pdfUrl: "",
    tags: ["typescript", "numerics"],
  },
];

// ---- Small UI bits ----
const Chip = ({ active, children, onClick }) => (
  <button
    onClick={onClick}
    className={`px-3 py-1 rounded-full text-sm border transition ${
      active ? "bg-black text-white dark:bg-white dark:text-black" : "hover:bg-neutral-100 dark:hover:bg-neutral-800"
    }`}
  >
    {children}
  </button>
);

const Field = ({ label, children, hint }) => (
  <label className="block">
    <span className="text-sm text-neutral-600 dark:text-neutral-300">{label}</span>
    <div className="mt-1">{children}</div>
    {hint ? <p className="text-xs text-neutral-500 mt-1">{hint}</p> : null}
  </label>
);

const Button = ({ as: Tag = "button", variant = "solid", className = "", children, ...props }) => (
  <Tag
    className={
      `inline-flex items-center gap-2 rounded-2xl px-4 py-2 text-sm font-medium shadow-sm transition active:translate-y-[1px] ` +
      (variant === "solid"
        ? "bg-black text-white hover:opacity-90 dark:bg-white dark:text-black"
        : variant === "ghost"
        ? "hover:bg-neutral-100 dark:hover:bg-neutral-800"
        : "border border-neutral-300 dark:border-neutral-700 hover:bg-neutral-50 dark:hover:bg-neutral-800") +
      (className ? ` ${className}` : "")
    }
    {...props}
  >
    {children}
  </Tag>
);

const Card = ({ children, className = "" }) => (
  <div className={`rounded-2xl border border-neutral-200 dark:border-neutral-800 bg-white/70 dark:bg-neutral-900/70 shadow-sm ${className}`}>
    {children}
  </div>
);

const TextInput = (props) => (
  <input
    {...props}
    className={`w-full rounded-xl border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-900 px-3 py-2 outline-none focus:ring-2 focus:ring-black/20 dark:focus:ring-white/20 ${
      props.className || ""
    }`}
  />
);

const TextArea = (props) => (
  <textarea
    {...props}
    className={`w-full min-h-[160px] rounded-xl border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-900 px-3 py-2 outline-none focus:ring-2 focus:ring-black/20 dark:focus:ring-white/20 ${
      props.className || ""
    }`}
  />
);

// ---- Theme ----
function useTheme() {
  const [theme, setTheme] = useState(() => ls.get("site_theme", "system"));
  useEffect(() => {
    const root = document.documentElement;
    const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
    const isDark = theme === "dark" || (theme === "system" && prefersDark);
    root.classList.toggle("dark", isDark);
    ls.set("site_theme", theme);
  }, [theme]);
  return { theme, setTheme };
}

// ---- Router (hash-based, no deps) ----
const ROUTES = ["blog", "projects", "about"]; // default: blog
function useHashRoute() {
  const [route, setRoute] = useState(() => {
    const hash = window.location.hash.replace("#", "").toLowerCase();
    return ROUTES.includes(hash) ? hash : "blog";
  });
  useEffect(() => {
    const onHash = () => {
      const hash = window.location.hash.replace("#", "").toLowerCase();
      setRoute(ROUTES.includes(hash) ? hash : "blog");
    };
    window.addEventListener("hashchange", onHash);
    return () => window.removeEventListener("hashchange", onHash);
  }, []);
  const navigate = (r) => {
    window.location.hash = r;
  };
  return { route, navigate };
}

// ---- Data hooks ----
function useProfile() {
  const [profile, setProfile] = useState(() => ls.get("site_profile", DEMO_PROFILE));
  useEffect(() => ls.set("site_profile", profile), [profile]);
  return [profile, setProfile];
}

function usePosts() {
  const [posts, setPosts] = useState(() => ls.get("blog_posts", DEMO_POSTS));
  useEffect(() => ls.set("blog_posts", posts), [posts]);
  return [posts, setPosts];
}

function useProjects() {
  const [projects, setProjects] = useState(() => ls.get("site_projects", DEMO_PROJECTS));
  useEffect(() => ls.set("site_projects", projects), [projects]);
  return [projects, setProjects];
}

// ---- Export / Import ----
function exportData(data) {
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `site-backup-${new Date().toISOString().slice(0, 10)}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function importData(file, setters) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const parsed = JSON.parse(reader.result);
        if (parsed.profile) setters.setProfile(parsed.profile);
        if (parsed.posts) setters.setPosts(parsed.posts);
        if (parsed.projects) setters.setProjects(parsed.projects);
        resolve(true);
      } catch (e) {
        reject(e);
      }
    };
    reader.onerror = reject;
    reader.readAsText(file);
  });
}

// ---- Navbar ----
function Navbar({ current, onNavigate, onExport, onImport, theme, setTheme, profile }) {
  const [importing, setImporting] = useState(false);
  return (
    <div className="sticky top-0 z-30 backdrop-blur supports-[backdrop-filter]:bg-white/60 dark:supports-[backdrop-filter]:bg-neutral-900/60 bg-white/80 dark:bg-neutral-900/80 border-b border-neutral-200 dark:border-neutral-800">
      <div className="mx-auto max-w-6xl px-4 py-3 flex items-center gap-3">
        <a href="#blog" className="flex items-center gap-3 group">
          <div className="size-9 rounded-xl bg-black text-white dark:bg-white dark:text-black grid place-items-center shadow-sm">
            <BookOpenText size={18} />
          </div>
          <div>
            <div className="font-semibold leading-tight">{profile?.name || "Your Name"}</div>
            <div className="text-xs text-neutral-500 -mt-0.5">{profile?.tagline || "Math & Physics"}</div>
          </div>
        </a>
        <div className="flex-1" />
        <nav className="flex items-center gap-1">
          {[
            { key: "blog", label: "Blog", icon: BookOpenText },
            { key: "projects", label: "Projects", icon: FolderGit2 },
            { key: "about", label: "About", icon: UserRound },
          ].map((tab) => (
            <Button
              key={tab.key}
              variant={current === tab.key ? "solid" : "ghost"}
              onClick={() => onNavigate(tab.key)}
              className="rounded-xl"
            >
              <tab.icon size={16} /> {tab.label}
            </Button>
          ))}
        </nav>
        <div className="flex items-center gap-2">
          <Button variant="ghost" onClick={() => setTheme(theme === "dark" ? "light" : theme === "light" ? "system" : "dark")}>
            {theme === "dark" ? <Moon size={16} /> : theme === "light" ? <Sun size={16} /> : <Sun size={16} />}
            <span className="sr-only">Toggle theme</span>
          </Button>
          <Button variant="outline" onClick={onExport}>
            <Download size={16} /> Export
          </Button>
          <label className="inline-flex items-center">
            <input
              type="file"
              accept="application/json"
              className="hidden"
              onChange={async (e) => {
                if (!e.target.files?.[0]) return;
                setImporting(true);
                try {
                  await onImport(e.target.files[0]);
                } finally {
                  setImporting(false);
                  e.target.value = "";
                }
              }}
            />
            <Button as="span" variant="outline" className={importing ? "opacity-60 pointer-events-none" : ""}>
              <Upload size={16} /> Import
            </Button>
          </label>
        </div>
      </div>
    </div>
  );
}

// ---- Blog ----
function BlogPage({ posts, setPosts }) {
  const [q, setQ] = useState("");
  const [topic, setTopic] = useState("all");
  const [editingId, setEditingId] = useState(null);
  const [draft, setDraft] = useState({ title: "", topic: "mathematics", content: "" });

  const filtered = useMemo(() => {
    return posts
      .filter((p) => (topic === "all" ? true : p.topic === topic))
      .filter((p) =>
        q
          ? [p.title, p.content].join("\n").toLowerCase().includes(q.toLowerCase())
          : true
      )
      .sort((a, b) => b.updatedAt - a.updatedAt);
  }, [posts, q, topic]);

  const startNew = () => {
    setEditingId("new");
    setDraft({ title: "", topic: "mathematics", content: "" });
    window.scrollTo({ top: 0, behavior: "smooth" });
  };

  const startEdit = (post) => {
    setEditingId(post.id);
    setDraft({ title: post.title, topic: post.topic, content: post.content });
    window.scrollTo({ top: 0, behavior: "smooth" });
  };

  const saveDraft = () => {
    if (!draft.title.trim()) return alert("Title required");
    if (editingId === "new") {
      const now = Date.now();
      setPosts([
        ...posts,
        {
          id: uid(),
          title: draft.title.trim(),
          topic: draft.topic,
          content: draft.content,
          createdAt: now,
          updatedAt: now,
          slug: slugify(draft.title),
        },
      ]);
    } else {
      setPosts(
        posts.map((p) =>
          p.id === editingId
            ? { ...p, title: draft.title.trim(), topic: draft.topic, content: draft.content, updatedAt: Date.now() }
            : p
        )
      );
    }
    setEditingId(null);
  };

  const remove = (id) => {
    if (confirm("Delete this post?")) setPosts(posts.filter((p) => p.id !== id));
  };

  return (
    <div className="mx-auto max-w-4xl p-4">
      <div className="flex items-center gap-2 mb-4">
        <div className="relative flex-1">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400" size={16} />
          <TextInput placeholder="Search posts" value={q} onChange={(e) => setQ(e.target.value)} className="pl-9" />
        </div>
        <Button onClick={startNew}>
          <Plus size={16} /> New Post
        </Button>
      </div>

      {editingId && (
        <Card className="p-4 mb-6">
          <div className="grid md:grid-cols-2 gap-4">
            <Field label="Title">
              <TextInput value={draft.title} onChange={(e) => setDraft({ ...draft, title: e.target.value })} />
            </Field>
            <Field label="Topic">
              <select
                value={draft.topic}
                onChange={(e) => setDraft({ ...draft, topic: e.target.value })}
                className="w-full rounded-xl border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-900 px-3 py-2"
              >
                <option value="mathematics">Mathematics</option>
                <option value="physics">Physics</option>
                <option value="other">Other</option>
              </select>
            </Field>
            <div className="md:col-span-2">
              <Field label="Content (Markdown supported)">
                <TextArea value={draft.content} onChange={(e) => setDraft({ ...draft, content: e.target.value })} />
              </Field>
            </div>
          </div>
          <div className="flex items-center gap-2 mt-4">
            <Button onClick={saveDraft}>Save</Button>
            <Button variant="outline" onClick={() => setEditingId(null)}>
              Cancel
            </Button>
          </div>
        </Card>
      )}

      <div className="flex items-center gap-2 mb-3">
        <Chip active={topic === "all"} onClick={() => setTopic("all")}>
          All
        </Chip>
        <Chip active={topic === "mathematics"} onClick={() => setTopic("mathematics")}>
          Mathematics
        </Chip>
        <Chip active={topic === "physics"} onClick={() => setTopic("physics")}>
          Physics
        </Chip>
        <Chip active={topic === "other"} onClick={() => setTopic("other")}>
          Other
        </Chip>
      </div>

      <div className="grid gap-4">
        <AnimatePresence>
          {filtered.map((p) => (
            <motion.div key={p.id} initial={{ opacity: 0, y: 8 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -8 }}>
              <Card className="p-5">
                <div className="flex items-start gap-3">
                  <div className="flex-1 min-w-0">
                    <h3 className="text-lg font-semibold leading-snug">{p.title}</h3>
                    <div className="text-xs text-neutral-500 mt-0.5">
                      {p.topic.charAt(0).toUpperCase() + p.topic.slice(1)} • Updated {fmtDate(p.updatedAt)}
                    </div>
                    <div className="prose prose-neutral dark:prose-invert max-w-none mt-3">
                      <ReactMarkdown>{p.content}</ReactMarkdown>
                    </div>
                  </div>
                  <div className="flex flex-col items-end gap-2 ml-2">
                    <Button variant="ghost" onClick={() => startEdit(p)}>
                      <PencilLine size={16} /> Edit
                    </Button>
                    <Button variant="ghost" onClick={() => remove(p.id)}>
                      <Trash2 size={16} /> Delete
                    </Button>
                  </div>
                </div>
              </Card>
            </motion.div>
          ))}
        </AnimatePresence>
      </div>

      {filtered.length === 0 && (
        <p className="text-neutral-500 text-sm mt-6">No posts yet. Click “New Post” to start writing.</p>
      )}
    </div>
  );
}

// ---- Projects ----
function ProjectsPage({ projects, setProjects }) {
  const [showForm, setShowForm] = useState(false);
  const [draft, setDraft] = useState({ title: "", description: "", projectUrl: "", pdfUrl: "", tags: "" });

  const add = () => {
    if (!draft.title.trim()) return alert("Title required");
    const proj = {
      id: uid(),
      title: draft.title.trim(),
      description: draft.description.trim(),
      projectUrl: draft.projectUrl.trim(),
      pdfUrl: draft.pdfUrl.trim(),
      tags: draft.tags
        .split(",")
        .map((t) => t.trim())
        .filter(Boolean),
    };
    setProjects([proj, ...projects]);
    setDraft({ title: "", description: "", projectUrl: "", pdfUrl: "", tags: "" });
    setShowForm(false);
  };

  const remove = (id) => {
    if (confirm("Delete this project?")) setProjects(projects.filter((p) => p.id !== id));
  };

  return (
    <div className="mx-auto max-w-5xl p-4">
      <div className="flex items-center justify-between mb-4">
        <h2 className="text-xl font-semibold">Projects</h2>
        <Button onClick={() => setShowForm((s) => !s)}>{showForm ? "Close" : (<><Plus size={16}/> New Project</>)}</Button>
      </div>

      {showForm && (
        <Card className="p-4 mb-6">
          <div className="grid md:grid-cols-2 gap-4">
            <Field label="Title"><TextInput value={draft.title} onChange={(e) => setDraft({ ...draft, title: e.target.value })} /></Field>
            <Field label="Tags (comma-separated)"><TextInput value={draft.tags} onChange={(e) => setDraft({ ...draft, tags: e.target.value })} placeholder="math, physics, web"/></Field>
            <div className="md:col-span-2"><Field label="Description"><TextArea value={draft.description} onChange={(e) => setDraft({ ...draft, description: e.target.value })} /></Field></div>
            <Field label="Project URL" hint="Repository or live demo link">
              <TextInput value={draft.projectUrl} onChange={(e) => setDraft({ ...draft, projectUrl: e.target.value })} placeholder="https://..." />
            </Field>
            <Field label="PDF URL (optional)" hint="Link to a paper, report, or PDF in your /public folder or anywhere online">
              <TextInput value={draft.pdfUrl} onChange={(e) => setDraft({ ...draft, pdfUrl: e.target.value })} placeholder="https://.../paper.pdf" />
            </Field>
          </div>
          <div className="flex items-center gap-2 mt-4">
            <Button onClick={add}><Plus size={16}/> Add Project</Button>
            <Button variant="outline" onClick={() => setShowForm(false)}>Cancel</Button>
          </div>
        </Card>
      )}

      <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
        {projects.map((p) => (
          <motion.div key={p.id} whileHover={{ y: -2 }}>
            <Card className="p-4 h-full flex flex-col">
              <div className="flex-1">
                <h3 className="font-semibold text-base leading-tight">{p.title}</h3>
                {p.tags?.length ? (
                  <div className="flex flex-wrap gap-1 mt-1">
                    {p.tags.map((t, i) => (
                      <span key={i} className="text-xs px-2 py-0.5 rounded-full bg-neutral-100 dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700">{t}</span>
                    ))}
                  </div>
                ) : null}
                <p className="text-sm text-neutral-600 dark:text-neutral-300 mt-2 line-clamp-4">{p.description}</p>
              </div>
              <div className="flex items-center gap-2 pt-3">
                {p.projectUrl && (
                  <Button as="a" href={p.projectUrl} target="_blank" rel="noreferrer" className="flex-1 justify-center">
                    <LinkIcon size={16}/> Project
                  </Button>
                )}
                {p.pdfUrl && (
                  <Button as="a" href={p.pdfUrl} target="_blank" rel="noreferrer" variant="outline" className="flex-1 justify-center">
                    <FileText size={16}/> PDF
                  </Button>
                )}
                <Button variant="ghost" onClick={() => remove(p.id)} title="Delete" className="ml-auto"><Trash2 size={16}/></Button>
              </div>
            </Card>
          </motion.div>
        ))}
      </div>

      {projects.length === 0 && <p className="text-neutral-500 text-sm mt-6">No projects yet. Add your first one above.</p>}
    </div>
  );
}

// ---- About ----
function AboutPage({ profile, setProfile }) {
  const [draft, setDraft] = useState(profile);
  useEffect(() => setDraft(profile), [profile]);

  const save = () => setProfile(draft);

  return (
    <div className="mx-auto max-w-3xl p-4">
      <div className="grid md:grid-cols-3 gap-6">
        <Card className="p-4 md:col-span-1">
          <div className="flex flex-col items-center text-center">
            <div className="size-28 rounded-2xl bg-neutral-100 dark:bg-neutral-800 overflow-hidden grid place-items-center">
              {draft.avatarUrl ? (
                <img src={draft.avatarUrl} alt="avatar" className="w-full h-full object-cover" />
              ) : (
                <UserRound className="text-neutral-400" />
              )}
            </div>
            <Field label="Avatar URL">
              <TextInput value={draft.avatarUrl} onChange={(e) => setDraft({ ...draft, avatarUrl: e.target.value })} placeholder="https://.../me.jpg" />
            </Field>
          </div>
        </Card>
        <Card className="p-4 md:col-span-2">
          <div className="grid gap-4">
            <Field label="Name"><TextInput value={draft.name} onChange={(e) => setDraft({ ...draft, name: e.target.value })} /></Field>
            <Field label="Tagline"><TextInput value={draft.tagline} onChange={(e) => setDraft({ ...draft, tagline: e.target.value })} placeholder="Essays on mathematics & physics"/></Field>
            <div className="grid md:grid-cols-2 gap-4">
              <Field label="Location"><TextInput value={draft.location} onChange={(e) => setDraft({ ...draft, location: e.target.value })} /></Field>
              <Field label="Email"><TextInput type="email" value={draft.email} onChange={(e) => setDraft({ ...draft, email: e.target.value })} /></Field>
            </div>
            <Field label="Bio"><TextArea value={draft.bio} onChange={(e) => setDraft({ ...draft, bio: e.target.value })} /></Field>
            <LinksEditor links={draft.links} onChange={(links) => setDraft({ ...draft, links })} />
            <div className="flex items-center gap-2">
              <Button onClick={save}><PencilLine size={16}/> Save</Button>
            </div>
          </div>
        </Card>
      </div>

      <Card className="p-4 mt-6">
        <h3 className="font-semibold mb-2">Preview</h3>
        <div className="prose prose-neutral dark:prose-invert max-w-none">
          <h1 className="mb-0">{profile.name || "Your Name"}</h1>
          <p className="mt-1">{profile.tagline}</p>
          <p className="mt-1 text-sm text-neutral-600 dark:text-neutral-300">{[profile.location, profile.email].filter(Boolean).join(" • ")}</p>
          <p className="whitespace-pre-wrap">{profile.bio}</p>
          {profile.links?.length ? (
            <p className="flex flex-wrap gap-2">
              {profile.links.map((l, i) => (
                <a key={i} className="underline decoration-dotted" href={l.url} target="_blank" rel="noreferrer">{l.label}</a>
              ))}
            </p>
          ) : null}
        </div>
      </Card>
    </div>
  );
}

function LinksEditor({ links, onChange }) {
  const [items, setItems] = useState(links || []);
  useEffect(() => setItems(links || []), [links]);
  useEffect(() => onChange(items), [items]);

  const add = () => setItems([...(items || []), { label: "", url: "" }]);
  const update = (i, patch) => setItems(items.map((it, idx) => (idx === i ? { ...it, ...patch } : it)));
  const remove = (i) => setItems(items.filter((_, idx) => idx !== i));

  return (
    <div>
      <div className="flex items-center justify-between mb-1">
        <span className="text-sm text-neutral-600 dark:text-neutral-300">Links</span>
        <Button variant="ghost" onClick={add}><Plus size={16}/> Add link</Button>
      </div>
      <div className="grid gap-2">
        {items.map((it, i) => (
          <div key={i} className="grid grid-cols-11 gap-2">
            <TextInput className="col-span-3" placeholder="Label" value={it.label} onChange={(e) => update(i, { label: e.target.value })} />
            <TextInput className="col-span-7" placeholder="https://..." value={it.url} onChange={(e) => update(i, { url: e.target.value })} />
            <Button variant="ghost" onClick={() => remove(i)} className="col-span-1"><Trash2 size={16}/></Button>
          </div>
        ))}
      </div>
    </div>
  );
}

// ---- Shell ----
export default function PersonalSite() {
  const { route, navigate } = useHashRoute();
  const [profile, setProfile] = useProfile();
  const [posts, setPosts] = usePosts();
  const [projects, setProjects] = useProjects();
  const { theme, setTheme } = useTheme();

  const onExport = () => exportData({ profile, posts, projects });
  const onImport = async (file) => importData(file, { setProfile, setPosts, setProjects });

  useEffect(() => {
    document.title = `${profile.name || "Your"} – ${route.charAt(0).toUpperCase() + route.slice(1)}`;
  }, [route, profile?.name]);

  return (
    <div className="min-h-screen bg-gradient-to-b from-neutral-50 to-white dark:from-neutral-950 dark:to-neutral-900 text-neutral-900 dark:text-neutral-50">
      <Navbar
        current={route}
        onNavigate={navigate}
        onExport={onExport}
        onImport={onImport}
        theme={theme}
        setTheme={setTheme}
        profile={profile}
      />

      <main className="mx-auto max-w-6xl">
        <AnimatePresence mode="wait">
          {route === "blog" && (
            <motion.section key="blog" initial={{ opacity: 0, y: 8 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -8 }}>
              <Hero profile={profile} />
              <BlogPage posts={posts} setPosts={setPosts} />
            </motion.section>
          )}
          {route === "projects" && (
            <motion.section key="projects" initial={{ opacity: 0, y: 8 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -8 }}>
              <SectionHeader title="Things I've built" subtitle="Code, papers, and experiments." />
              <ProjectsPage projects={projects} setProjects={setProjects} />
            </motion.section>
          )}
          {route === "about" && (
            <motion.section key="about" initial={{ opacity: 0, y: 8 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -8 }}>
              <SectionHeader title="About me" subtitle="Edit and save your profile below." />
              <AboutPage profile={profile} setProfile={setProfile} />
            </motion.section>
          )}
        </AnimatePresence>
      </main>

      <footer className="border-t border-neutral-200 dark:border-neutral-800 mt-8">
        <div className="mx-auto max-w-6xl p-4 text-sm text-neutral-500 flex items-center justify-between">
          <div>© {new Date().getFullYear()} {profile.name || "Your Name"}</div>
          <div className="flex items-center gap-3">
            <a href="#blog" className="hover:underline">Blog</a>
            <a href="#projects" className="hover:underline">Projects</a>
            <a href="#about" className="hover:underline">About</a>
          </div>
        </div>
      </footer>
    </div>
  );
}

function Hero({ profile }) {
  return (
    <div className="mx-auto max-w-4xl px-4 pt-10">
      <div className="grid md:grid-cols-[1fr,auto] items-center gap-6">
        <div>
          <h1 className="text-3xl md:text-4xl font-semibold tracking-tight">{profile?.tagline || "Essays on mathematics & physics"}</h1>
          <p className="text-neutral-600 dark:text-neutral-300 mt-2 max-w-2xl">{profile?.bio?.split("\n")[0] || "A clean, fast space for your long-form writing."}</p>
        </div>
        <div className="hidden md:block">
          <div className="size-20 rounded-2xl bg-black text-white dark:bg-white dark:text-black grid place-items-center shadow">
            <BookOpenText />
          </div>
        </div>
      </div>
    </div>
  );
}

function SectionHeader({ title, subtitle }) {
  return (
    <div className="mx-auto max-w-4xl px-4 pt-8 pb-2">
      <h2 className="text-2xl font-semibold">{title}</h2>
      {subtitle && <p className="text-neutral-600 dark:text-neutral-300 mt-1">{subtitle}</p>}
    </div>
  );
}
